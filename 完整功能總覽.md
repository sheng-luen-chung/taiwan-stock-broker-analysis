# 🎯 完整功能總覽 - 台灣證券交易所券商進出明細分析工具

> 📈 從資料下載到深度分析的完整解決方案

## 🚀 工具概述

這是一個完整的股票券商進出明細分析工具包，提供從原始資料下載到深度分析的全流程解決方案。

## 📦 工具組合

### 🔽 第一階段：資料下載工具

| 工具名稱 | 適用情況 | 特色 |
|---------|---------|------|
| **`stock_scraper.py`** | 推薦使用 | OCR 自動識別驗證碼 |
| **`stock_scraper_manual.py`** | OCR 安裝困難 | 手動輸入驗證碼 |
| **`simple_downloader.py`** | 簡單需求 | 精簡版功能 |
| **`快速下載.bat`** | 新手用戶 | 一鍵執行，無需命令列 |

### 📊 第二階段：深度分析工具

| 分析步驟 | 輸出檔案 | 功能說明 |
|---------|---------|---------|
| **Step 1** | `step1_flattened.csv` | 資料展平與標準化 |
| **Step 2** | `step2_branch_summary.csv/.xlsx` | 分點券商買賣統計 |
| **Step 3** | `step3_mother_summary.csv/.xlsx` | 母券商合併統計 |
| **Step 4** | `step4_avg_method_pnl.csv/.xlsx` | 平均價格法損益 |
| **Step 5** | `step5_fifo_with_carry.csv/.xlsx` | FIFO 撮合損益（含結轉） |
| **Step 6** | `step6_top10_profit/loss.csv` | 前十大獲利/虧損券商 |
| **Step 7** | `step7_netbuy_netsell_pnl.xlsx` | 淨買賣超排行榜 |

## 🎯 使用流程

### 流程一：快速分析（推薦新手）

```bash
# 1. 一鍵下載資料
快速下載.bat
# 輸入股票代碼：2317

# 2. 一鍵深度分析
python broker_pipeline.py --input "2317_處理後資料_時間戳記.csv"
```

### 流程二：進階分析（推薦熟練用戶）

```bash
# 1. 命令列下載
python stock_scraper.py 2317 --retries 10

# 2. 指定輸出資料夾分析
python broker_pipeline.py --input "2317_處理後資料_時間戳記.csv" --outdir "analysis_2317"
```

### 流程三：批次處理（推薦大量分析）

```bash
# 1. 建立批次下載腳本
echo python stock_scraper.py 2317 > batch_download.bat
echo timeout /t 15 /nobreak ^> nul >> batch_download.bat
echo python stock_scraper.py 2330 >> batch_download.bat
echo timeout /t 15 /nobreak ^> nul >> batch_download.bat
echo python stock_scraper.py 4958 >> batch_download.bat

# 2. 建立批次分析腳本
echo python broker_pipeline.py --input "2317_處理後資料_時間.csv" > batch_analysis.bat
echo python broker_pipeline.py --input "2330_處理後資料_時間.csv" >> batch_analysis.bat
echo python broker_pipeline.py --input "4958_處理後資料_時間.csv" >> batch_analysis.bat
```

## 📁 輸出結果結構

```
broker_analysis/
├── 原始下載檔案
│   ├── 2317_爬蟲資料_20250907_110152.csv
│   └── 2317_處理後資料_20250907_110152.csv
└── output/
    └── analysis_2317_處理後資料_20250907_110152/
        ├── step1_flattened.csv                    # 展平資料
        ├── step2_branch_summary.csv/.xlsx         # 分點統計
        ├── step3_mother_summary.csv/.xlsx         # 母券商統計
        ├── step4_avg_method_pnl.csv/.xlsx         # 平均法損益
        ├── step5_fifo_with_carry.csv/.xlsx        # FIFO 損益
        ├── step6_top10_profit.csv                 # 前十獲利
        ├── step6_top10_loss.csv                   # 前十虧損
        ├── step7_top10_netbuy_pnl.csv            # 淨買超榜
        ├── step7_top10_netsell_pnl.csv           # 淨賣超榜
        └── step7_netbuy_netsell_pnl.xlsx         # 綜合分析
```

## 🎛️ 高級功能

### 自動分類儲存

每個 CSV 檔案的分析結果會自動儲存在專屬資料夾：

```bash
# 分析檔案A
python broker_pipeline.py --input "2317_處理後資料_20250907_110152.csv"
# 結果存在: output/analysis_2317_處理後資料_20250907_110152/

# 分析檔案B
python broker_pipeline.py --input "2317_處理後資料_20250907_121846.csv"
# 結果存在: output/analysis_2317_處理後資料_20250907_121846/
```

### 多格式輸出

- **CSV 格式**: 適合程式處理和進一步分析
- **Excel 格式**: 適合人工檢視和報告製作
- **UTF-8 編碼**: 完美支援中文，可直接用 Excel 開啟

### 智能資料處理

- **自動格式偵測**: 支援原始格式和帶註解格式
- **左右並排重構**: 自動處理證交所的左右並排資料格式
- **編碼自動偵測**: 支援 UTF-8-BOM、UTF-8、Big5 編碼

## 🔧 安裝與設定

### 一鍵安裝（推薦）

```bash
# 雙擊執行
install.bat

# 驗證安裝（重要！）
python check_installation.py
```

`check_installation.py` 會進行完整的系統檢查：
- ✅ Python 版本檢查
- ✅ 所有套件安裝狀況
- ✅ OCR 引擎初始化測試
- ✅ 網路連線測試
- ✅ 詳細診斷報告

### 手動安裝

```bash
# 基礎套件
pip install numpy==1.24.4 onnxruntime==1.16.3
pip install opencv-python-headless==4.8.1.78 pillow==10.0.1
pip install ddddocr==1.4.11

# 爬蟲套件
pip install requests beautifulsoup4 lxml

# 資料分析套件
pip install pandas openpyxl
```

## 📊 分析結果解讀

### 券商損益分析

- **平均價格法**: 使用當日平均價格計算損益
- **FIFO 法**: 先進先出法計算實際損益
- **結轉處理**: 正確處理跨日持倉

### 統計指標

- **買進/賣出股數**: 券商實際交易量
- **淨買賣**: 買進減去賣出的淨額
- **損益金額**: 根據價格變動計算的損益

### 排行榜

- **前十大獲利券商**: 當日獲利最多的券商
- **前十大虧損券商**: 當日虧損最多的券商
- **淨買超/賣超**: 淨買進/賣出最多的券商

## 🎯 實戰應用場景

### 場景一：個股分析

```bash
# 下載鴻海資料
python stock_scraper.py 2317

# 分析鴻海券商進出
python broker_pipeline.py --input "2317_處理後資料_時間.csv"

# 查看結果
# Excel: output/analysis_2317_xxx/step7_netbuy_netsell_pnl.xlsx
```

### 場景二：多股比較

```bash
# 下載多檔股票
python stock_scraper.py 2317  # 鴻海
python stock_scraper.py 2330  # 台積電

# 分別分析
python broker_pipeline.py --input "2317_處理後資料_時間.csv"
python broker_pipeline.py --input "2330_處理後資料_時間.csv"

# 比較: output/analysis_2317_xxx/ vs output/analysis_2330_xxx/
```

### 場景三：時間序列分析

```bash
# 下載不同時間點的相同股票
python stock_scraper.py 2317  # 時間點1
# 等待...
python stock_scraper.py 2317  # 時間點2

# 分析變化趨勢
python broker_pipeline.py --input "2317_處理後資料_時間1.csv"
python broker_pipeline.py --input "2317_處理後資料_時間2.csv"
```

## 💡 最佳實踐

### 使用時機
- **最佳下載時間**: 收盤後 15:00-18:00
- **避免時間**: 開盤時段（網站負載高）

### 頻率控制
```bash
# 建議間隔 10-15 秒
python stock_scraper.py 2317
timeout /t 15 /nobreak > nul
python stock_scraper.py 2330
```

### 資料管理
- 定期清理舊的分析結果
- 備份重要的分析檔案
- 使用有意義的檔名標記

## 🆘 故障排除

### 常見問題

1. **OCR 安裝失敗** → 使用 `stock_scraper_manual.py`
2. **驗證碼識別錯誤** → 增加重試次數 `--retries 10`
3. **網路連線問題** → 檢查防火牆設定
4. **CSV 格式錯誤** → 確認檔案完整下載

### 支援管道

- 📖 查看 `README.md` 詳細說明
- 🔧 查看 `INSTALL.md` 安裝指南
- 🚀 查看 `快速使用指南.md` 入門教學

## 🎉 開始使用

現在就開始您的股票券商分析之旅：

```bash
# 第一步：安裝環境
install.bat

# 第二步：下載資料
快速下載.bat

# 第三步：深度分析
python broker_pipeline.py --input "您的檔案.csv"
```

---

*最後更新時間: 2025年9月7日*
